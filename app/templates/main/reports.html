{% extends "base.html" %}

{% block title %}Reports{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h2><i class="fas fa-chart-line text-primary"></i> Expense Reports</h2>
        <p class="text-muted mb-0">Analyze your spending patterns and trends</p>
    </div>
    <div class="btn-group">
        <button type="button" class="btn btn-outline-secondary" onclick="window.print()">
            <i class="fas fa-print"></i> Print
        </button>
        <button type="button" class="btn btn-outline-secondary" onclick="exportToPDF()">
            <i class="fas fa-file-pdf"></i> Export PDF
        </button>
    </div>
</div>
{% endblock %}

{% block content %}
<!-- Report Filters -->
<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form method="GET" class="row g-3">
            <div class="col-md-3">
                <label class="form-label">Report Period</label>
                <select class="form-select" name="period">
                    <option value="current_month" {{ 'selected' if request.args.get('period') == 'current_month' else '' }}>Current Month</option>
                    <option value="last_month" {{ 'selected' if request.args.get('period') == 'last_month' else '' }}>Last Month</option>
                    <option value="current_quarter" {{ 'selected' if request.args.get('period') == 'current_quarter' else '' }}>Current Quarter</option>
                    <option value="current_year" {{ 'selected' if request.args.get('period') == 'current_year' else '' }}>Current Year</option>
                    <option value="custom" {{ 'selected' if request.args.get('period') == 'custom' else '' }}>Custom Range</option>
                </select>
            </div>
            <div class="col-md-2" id="custom-dates" style="display: {{ 'block' if request.args.get('period') == 'custom' else 'none' }};">
                <label class="form-label">From Date</label>
                <input type="date" class="form-control" name="start_date" value="{{ request.args.get('start_date', '') }}">
            </div>
            <div class="col-md-2" id="custom-dates-end" style="display: {{ 'block' if request.args.get('period') == 'custom' else 'none' }};">
                <label class="form-label">To Date</label>
                <input type="date" class="form-control" name="end_date" value="{{ request.args.get('end_date', '') }}">
            </div>
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select class="form-select" name="category">
                    <option value="">All Categories</option>
                    {% for category in categories %}
                    <option value="{{ category.id }}" {{ 'selected' if request.args.get('category') == category.id|string else '' }}>
                        {{ category.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-2 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100">
                    <i class="fas fa-chart-bar"></i> Generate
                </button>
            </div>
        </form>
    </div>
</div>

<!-- Investment Analysis Section -->
{% if total_invested > 0 %}
<div class="row mt-2 mb-4">
    <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-chart-line text-success"></i> Investment Analysis</h4>
    </div>
</div>

<!-- Investment Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-coins fa-2x mb-2"></i>
                <h4>{{ get_currency_symbol() }}{{ "%.2f"|format(total_invested) }}</h4>
                <p class="mb-0">Total Invested</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-wallet fa-2x mb-2"></i>
                <h4>{{ get_currency_symbol() }}{{ "%.2f"|format(total_current_value) }}</h4>
                <p class="mb-0">Current Value</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card {% if investment_returns >= 0 %}bg-primary{% else %}bg-danger{% endif %} text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-line fa-2x mb-2"></i>
                <h4>{{ get_currency_symbol() }}{{ "%.2f"|format(investment_returns) }}</h4>
                <p class="mb-0">Returns</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-chart-pie fa-2x mb-2"></i>
                <h4>{{ total_investment_count }}</h4>
                <p class="mb-0">Total Investments</p>
            </div>
        </div>
    </div>
</div>

<!-- Investment Charts Row -->
<div class="row mb-4">
    <!-- Investment by Type -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Investment Distribution by Type</h6>
            </div>
            <div class="card-body">
                <canvas id="investmentTypeChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Investment Performance -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Investment Type Breakdown</h6>
            </div>
            <div class="card-body">
                {% for inv_stat in investment_stats %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <i class="{{ inv_stat.icon }} text-success"></i> {{ inv_stat.name }}
                        <br>
                        <small class="text-muted">{{ inv_stat.count }} investments</small>
                    </div>
                    <div class="text-end">
                        <strong>{{ get_currency_symbol() }}{{ "%.0f"|format(inv_stat.total) }}</strong>
                        <br>
                        <small class="{% if inv_stat.returns >= 0 %}text-success{% else %}text-danger{% endif %}">
                            {% if inv_stat.returns >= 0 %}+{% endif %}{{ get_currency_symbol() }}{{ "%.0f"|format(inv_stat.returns) }}
                        </small>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 6px;">
                    <div class="progress-bar bg-success" 
                         style="width: {{ inv_stat.percentage }}%"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
</div>
{% endif %}

<!-- Expense Analysis Section -->
<div class="row mt-4 mb-4">
    <div class="col-12">
        <h4 class="mb-3"><i class="fas fa-receipt text-primary"></i> Expense Analysis</h4>
    </div>
</div>

<!-- Summary Cards -->
<div class="row mb-4">
    <div class="col-md-3">
        <div class="card bg-primary text-white">
            <div class="card-body text-center">
                <i class="fas fa-coins fa-2x mb-2"></i>
                <h4>{{ get_currency_symbol() }}{{ "%.2f"|format(summary.total_expenses) }}</h4>
                <p class="mb-0">Total Expenses</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-success text-white">
            <div class="card-body text-center">
                <i class="fas fa-receipt fa-2x mb-2"></i>
                <h4>{{ summary.expense_count }}</h4>
                <p class="mb-0">Total Transactions</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-info text-white">
            <div class="card-body text-center">
                <i class="fas fa-calculator fa-2x mb-2"></i>
                <h4>{{ get_currency_symbol() }}{{ "%.2f"|format(summary.avg_expense) }}</h4>
                <p class="mb-0">Average Expense</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card bg-warning text-white">
            <div class="card-body text-center">
                <i class="fas fa-tags fa-2x mb-2"></i>
                <h4>{{ summary.categories_used }}</h4>
                <p class="mb-0">Categories Used</p>
            </div>
        </div>
    </div>
</div>

<!-- Charts Row -->
<div class="row mb-4">
    <!-- Spending by Category -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Spending by Category</h6>
            </div>
            <div class="card-body">
                <canvas id="categoryChart" height="300"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Spending Trend -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Spending Trend</h6>
            </div>
            <div class="card-body">
                <canvas id="trendChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Payment Methods & Top Expenses -->
<div class="row mb-4">
    <!-- Payment Methods -->
    <div class="col-lg-4">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Payment Methods</h6>
            </div>
            <div class="card-body">
                <canvas id="paymentChart" height="250"></canvas>
            </div>
        </div>
    </div>
    
    <!-- Top Expenses -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Top Expenses</h6>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-sm">
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Description</th>
                                <th>Category</th>
                                <th class="text-end">Amount</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for expense in top_expenses %}
                            <tr>
                                <td>{{ expense.date.strftime('%m/%d/%Y') }}</td>
                                <td>{{ expense.title }}</td>
                                <td>
                                    <span class="badge bg-{{ expense.category.color }}">
                                        <i class="{{ expense.category.icon }}"></i> {{ expense.category.name }}
                                    </span>
                                </td>
                                <td class="text-end">{{ get_currency_symbol() }}{{ "%.2f"|format(expense.amount) }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Detailed Analysis -->
<div class="row">
    <!-- Category Breakdown -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Category Breakdown</h6>
            </div>
            <div class="card-body">
                {% for category_stat in category_stats %}
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <div>
                        <span class="badge bg-{{ category_stat.color }}">
                            <i class="{{ category_stat.icon }}"></i> {{ category_stat.name }}
                        </span>
                        <br>
                        <small class="text-muted">{{ category_stat.count }} expenses</small>
                    </div>
                    <div class="text-end">
                        <strong>{{ get_currency_symbol() }}{{ "%.0f"|format(category_stat.total) }}</strong>
                        <br>
                        <small class="text-muted">{{ "%.1f"|format(category_stat.percentage) }}%</small>
                    </div>
                </div>
                <div class="progress mb-3" style="height: 6px;">
                    <div class="progress-bar bg-{{ category_stat.color }}" 
                         style="width: {{ category_stat.percentage }}%"></div>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    
    <!-- Monthly Comparison -->
    <div class="col-lg-6">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Monthly Comparison</h6>
            </div>
            <div class="card-body">
                <canvas id="monthlyChart" height="300"></canvas>
            </div>
        </div>
    </div>
</div>

<!-- Budget Performance (if budgets exist) -->
{% if budget_performance %}
<div class="row mt-4">
    <div class="col-12">
        <div class="card shadow-sm">
            <div class="card-header">
                <h6 class="mb-0">Budget Performance</h6>
            </div>
            <div class="card-body">
                <div class="row">
                    {% for budget in budget_performance %}
                    <div class="col-md-6 col-lg-4 mb-3">
                        <div class="card border-left-{{ budget.category.color }}">
                            <div class="card-body p-3">
                                <h6 class="mb-2">{{ budget.category.name }}</h6>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Spent</span>
                                    <strong>{{ get_currency_symbol() }}{{ "%.0f"|format(budget.spent) }}</strong>
                                </div>
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="text-muted">Budget</span>
                                    <span>{{ get_currency_symbol() }}{{ "%.0f"|format(budget.amount) }}</span>
                                </div>
                                <div class="progress mb-2" style="height: 8px;">
                                    {% set percentage = (budget.spent / budget.amount * 100) if budget.amount > 0 else 0 %}
                                    <div class="progress-bar {% if percentage > 100 %}bg-danger{% elif percentage > 90 %}bg-warning{% else %}bg-success{% endif %}" 
                                         style="width: {{ [percentage, 100]|min }}%"></div>
                                </div>
                                <div class="text-center">
                                    {% if percentage <= 100 %}
                                    <small class="text-success">{{ "%.1f"|format(percentage) }}% used</small>
                                    {% else %}
                                    <small class="text-danger">{{ "%.1f"|format(percentage - 100) }}% over budget</small>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_css %}
<style>
@media print {
    .btn-group, .card-header .btn, .no-print {
        display: none !important;
    }
    
    .card {
        break-inside: avoid;
        margin-bottom: 1rem;
    }
    
    body {
        font-size: 12px;
    }
}

.border-left-primary { border-left: 4px solid var(--bs-primary) !important; }
.border-left-success { border-left: 4px solid var(--bs-success) !important; }
.border-left-warning { border-left: 4px solid var(--bs-warning) !important; }
.border-left-danger { border-left: 4px solid var(--bs-danger) !important; }
.border-left-info { border-left: 4px solid var(--bs-info) !important; }
.border-left-secondary { border-left: 4px solid var(--bs-secondary) !important; }
.border-left-dark { border-left: 4px solid var(--bs-dark) !important; }
.border-left-light { border-left: 4px solid var(--bs-light) !important; }
</style>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Toggle custom date fields
    const periodSelect = document.querySelector('select[name="period"]');
    const customDates = document.getElementById('custom-dates');
    const customDatesEnd = document.getElementById('custom-dates-end');
    
    if (periodSelect) {
        periodSelect.addEventListener('change', function() {
            if (this.value === 'custom') {
                customDates.style.display = 'block';
                customDatesEnd.style.display = 'block';
            } else {
                customDates.style.display = 'none';
                customDatesEnd.style.display = 'none';
            }
        });
    }
    
    // Category Chart
    const categoryCtx = document.getElementById('categoryChart');
    if (categoryCtx) {
        new Chart(categoryCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for cat in category_stats %}'{{ cat.name }}'{{ ',' if not loop.last }}{% endfor %}],
                datasets: [{
                    data: [{% for cat in category_stats %}{{ cat.total }}{{ ',' if not loop.last }}{% endfor %}],
                    backgroundColor: [
                        {% for cat in category_stats %}
                        '{% if cat.color == "primary" %}#0d6efd{% elif cat.color == "success" %}#198754{% elif cat.color == "warning" %}#ffc107{% elif cat.color == "danger" %}#dc3545{% elif cat.color == "info" %}#0dcaf0{% elif cat.color == "secondary" %}#6c757d{% elif cat.color == "dark" %}#212529{% else %}#f8f9fa{% endif %}'{{ ',' if not loop.last }}
                        {% endfor %}
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const percentage = ((context.parsed / {{ summary.total_expenses }}) * 100).toFixed(1);
                                return context.label + ': $' + context.parsed.toFixed(0) + ' (' + percentage + '%)';
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Trend Chart
    const trendCtx = document.getElementById('trendChart');
    if (trendCtx) {
        new Chart(trendCtx, {
            type: 'line',
            data: {
                labels: [{% for trend in trend_data %}'{{ trend.label }}'{{ ',' if not loop.last }}{% endfor %}],
                datasets: [{
                    label: 'Daily Spending',
                    data: [{% for trend in trend_data %}{{ trend.amount }}{{ ',' if not loop.last }}{% endfor %}],
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Payment Methods Chart
    const paymentCtx = document.getElementById('paymentChart');
    if (paymentCtx) {
        new Chart(paymentCtx, {
            type: 'pie',
            data: {
                labels: [{% for payment in payment_methods %}'{{ payment.method }}'{{ ',' if not loop.last }}{% endfor %}],
                datasets: [{
                    data: [{% for payment in payment_methods %}{{ payment.total }}{{ ',' if not loop.last }}{% endfor %}],
                    backgroundColor: ['#0d6efd', '#198754', '#ffc107', '#dc3545', '#0dcaf0']
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                }
            }
        });
    }
    
    // Investment Type Chart
    const investmentTypeCtx = document.getElementById('investmentTypeChart');
    if (investmentTypeCtx) {
        new Chart(investmentTypeCtx, {
            type: 'doughnut',
            data: {
                labels: [{% for inv in investment_stats %}'{{ inv.name }}'{{ ',' if not loop.last }}{% endfor %}],
                datasets: [{
                    data: [{% for inv in investment_stats %}{{ inv.total }}{{ ',' if not loop.last }}{% endfor %}],
                    backgroundColor: [
                        '#198754', '#0d6efd', '#ffc107', '#dc3545', 
                        '#0dcaf0', '#6f42c1', '#fd7e14', '#20c997', '#6c757d'
                    ]
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { 
                        position: 'bottom',
                        labels: {
                            generateLabels: function(chart) {
                                const data = chart.data;
                                if (data.labels.length && data.datasets.length) {
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                        const percentage = ((value / total) * 100).toFixed(1);
                                        return {
                                            text: `${label}: $${value.toFixed(0)} (${percentage}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            index: i
                                        };
                                    });
                                }
                                return [];
                            }
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const label = context.label || '';
                                const value = context.parsed || 0;
                                return label + ': $' + value.toFixed(0);
                            }
                        }
                    }
                }
            }
        });
    }
    
    // Monthly Comparison Chart
    const monthlyCtx = document.getElementById('monthlyChart');
    if (monthlyCtx) {
        new Chart(monthlyCtx, {
            type: 'bar',
            data: {
                labels: [{% for month in monthly_data %}'{{ month.label }}'{{ ',' if not loop.last }}{% endfor %}],
                datasets: [{
                    label: 'Monthly Spending',
                    data: [{% for month in monthly_data %}{{ month.amount }}{{ ',' if not loop.last }}{% endfor %}],
                    backgroundColor: '#0d6efd'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return '$' + value;
                            }
                        }
                    }
                }
            }
        });
    }
});

function exportToPDF() {
    window.print();
}
</script>
{% endblock %}