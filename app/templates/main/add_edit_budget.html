{% extends "base.html" %}
{% from 'bootstrap5/form.html' import render_form %}

{% block title %}
{% if budget %}Edit Budget{% else %}Add Budget{% endif %}
{% endblock %}

{% block page_header %}
<div class="d-flex justify-content-between align-items-center">
    <div>
        <h2>
            <i class="fas fa-{% if budget %}edit{% else %}plus-circle{% endif %} text-primary"></i>
            {% if budget %}Edit Budget{% else %}Set New Budget{% endif %}
        </h2>
        <p class="text-muted mb-0">
            {% if budget %}Update budget limits and settings{% else %}Set spending limits for better financial control{% endif %}
        </p>
    </div>
    <a href="{{ url_for('main.budgets') }}" class="btn btn-outline-secondary">
        <i class="fas fa-arrow-left"></i> Back to Budgets
    </a>
</div>
{% endblock %}

{% block content %}
<div class="row">
    <!-- Main Form -->
    <div class="col-lg-8">
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h5 class="card-title mb-0">
                    <i class="fas fa-chart-pie text-primary"></i> Budget Details
                </h5>
            </div>
            <div class="card-body">
                <form method="POST" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <!-- Category -->
                        <div class="col-md-6 mb-3">
                            {{ form.category_id.label(class="form-label fw-bold") }}
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-tag"></i>
                                </span>
                                {{ form.category_id(class="form-select" + (" is-invalid" if form.category_id.errors else "")) }}
                                {% if form.category_id.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.category_id.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- Budget Amount -->
                        <div class="col-md-6 mb-3">
                            {{ form.amount.label(class="form-label fw-bold") }}
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-dollar-sign"></i>
                                </span>
                                {{ form.amount(class="form-control" + (" is-invalid" if form.amount.errors else ""), 
                                              placeholder="0.00", 
                                              step="0.01",
                                              min="0") }}
                                {% if form.amount.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.amount.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <div class="row">
                        <!-- Start Date -->
                        <div class="col-md-6 mb-3">
                            {{ form.start_date.label(class="form-label fw-bold") }}
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-calendar-alt"></i>
                                </span>
                                {{ form.start_date(class="form-control" + (" is-invalid" if form.start_date.errors else "")) }}
                                {% if form.start_date.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.start_date.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                        
                        <!-- End Date -->
                        <div class="col-md-6 mb-3">
                            {{ form.end_date.label(class="form-label fw-bold") }}
                            <div class="input-group">
                                <span class="input-group-text">
                                    <i class="fas fa-calendar-check"></i>
                                </span>
                                {{ form.end_date(class="form-control" + (" is-invalid" if form.end_date.errors else "")) }}
                                {% if form.end_date.errors %}
                                    <div class="invalid-feedback">
                                        {{ form.end_date.errors[0] }}
                                    </div>
                                {% endif %}
                            </div>
                        </div>
                    </div>
                    
                    <!-- Quick Period Buttons -->
                    <div class="mb-3">
                        <label class="form-label">Quick Select Period</label>
                        <div class="btn-group w-100" role="group">
                            <button type="button" class="btn btn-outline-secondary" onclick="setCurrentMonth()">
                                Current Month
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setNextMonth()">
                                Next Month
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setQuarter()">
                                Current Quarter
                            </button>
                            <button type="button" class="btn btn-outline-secondary" onclick="setYear()">
                                Current Year
                            </button>
                        </div>
                    </div>
                    
                    <!-- Description -->
                    <div class="mb-4">
                        {{ form.description.label(class="form-label") }}
                        {{ form.description(class="form-control", 
                                          placeholder="Optional: Add notes about this budget...", 
                                          rows="3") }}
                    </div>
                    
                    <!-- Budget Preview -->
                    <div class="alert alert-info" id="budget-preview" style="display: none;">
                        <h6><i class="fas fa-calculator"></i> Budget Preview</h6>
                        <div class="row">
                            <div class="col-md-4">
                                <strong>Daily Limit:</strong> $<span id="daily-limit">0</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Weekly Limit:</strong> $<span id="weekly-limit">0</span>
                            </div>
                            <div class="col-md-4">
                                <strong>Duration:</strong> <span id="duration">0</span> days
                            </div>
                        </div>
                    </div>
                    
                    <!-- Submit Buttons -->
                    <div class="d-grid gap-2 d-md-flex justify-content-md-between">
                        {% if budget %}
                        <form method="POST" action="{{ url_for('main.delete_budget', id=budget.id) }}" 
                              class="d-inline" onsubmit="return confirm('Are you sure you want to delete this budget?')">
                            <button type="submit" class="btn btn-outline-danger">
                                <i class="fas fa-trash"></i> Delete Budget
                            </button>
                        </form>
                        {% else %}
                        <div></div>
                        {% endif %}
                        
                        <div class="btn-group">
                            <a href="{{ url_for('main.budgets') }}" class="btn btn-outline-secondary">
                                <i class="fas fa-times"></i> Cancel
                            </a>
                            {{ form.submit(class="btn btn-primary") }}
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
    
    <!-- Sidebar -->
    <div class="col-lg-4">
        <!-- Category Info -->
        {% if selected_category %}
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-{{ selected_category.color }} text-white">
                <h6 class="mb-0">
                    <i class="{{ selected_category.icon }}"></i> {{ selected_category.name }}
                </h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-6">This Month:</dt>
                    <dd class="col-sm-6">{{ get_currency_symbol() }}{{ "%.0f"|format(selected_category.current_month_spending or 0) }}</dd>
                    
                    <dt class="col-sm-6">Last Month:</dt>
                    <dd class="col-sm-6">{{ get_currency_symbol() }}{{ "%.0f"|format(selected_category.last_month_spending or 0) }}</dd>
                    
                    <dt class="col-sm-6">Average:</dt>
                    <dd class="col-sm-6">{{ get_currency_symbol() }}{{ "%.0f"|format(selected_category.avg_monthly_spending or 0) }}</dd>
                    
                    <dt class="col-sm-6">Total Expenses:</dt>
                    <dd class="col-sm-6">{{ selected_category.expense_count or 0 }}</dd>
                </dl>
            </div>
        </div>
        {% endif %}
        
        <!-- Budget Recommendations -->
        <div class="card shadow-sm mb-4">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="fas fa-lightbulb text-warning"></i> Budget Recommendations
                </h6>
            </div>
            <div class="card-body">
                {% if selected_category %}
                <div class="mb-3">
                    <strong>Suggested Budget:</strong>
                    <div class="d-grid gap-2 mt-2">
                        {% if selected_category.avg_monthly_spending > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-primary" 
                                onclick="setBudgetAmount({{ selected_category.avg_monthly_spending * 1.1 }})">
                            {{ get_currency_symbol() }}{{ "%.0f"|format(selected_category.avg_monthly_spending * 1.1) }} 
                            <small>(110% of average)</small>
                        </button>
                        <button type="button" class="btn btn-sm btn-outline-success" 
                                onclick="setBudgetAmount({{ selected_category.avg_monthly_spending }})">
                            {{ get_currency_symbol() }}{{ "%.0f"|format(selected_category.avg_monthly_spending) }} 
                            <small>(Average spending)</small>
                        </button>
                        {% endif %}
                        {% if selected_category.last_month_spending > 0 %}
                        <button type="button" class="btn btn-sm btn-outline-info" 
                                onclick="setBudgetAmount({{ selected_category.last_month_spending }})">
                            {{ get_currency_symbol() }}{{ "%.0f"|format(selected_category.last_month_spending) }} 
                            <small>(Last month)</small>
                        </button>
                        {% endif %}
                    </div>
                </div>
                {% endif %}
                
                <ul class="list-unstyled mb-0">
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Set realistic and achievable limits
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Review and adjust budgets monthly
                    </li>
                    <li class="mb-2">
                        <i class="fas fa-check text-success"></i>
                        Leave room for unexpected expenses
                    </li>
                    <li class="mb-0">
                        <i class="fas fa-check text-success"></i>
                        Track progress regularly
                    </li>
                </ul>
            </div>
        </div>
        
        <!-- Existing Budget Alert -->
        {% if existing_budget %}
        <div class="alert alert-warning">
            <h6 class="alert-heading">
                <i class="fas fa-exclamation-triangle"></i> Existing Budget
            </h6>
            <p class="mb-2">This category already has a budget for this period:</p>
            <ul class="mb-2">
                <li><strong>Amount:</strong> {{ get_currency_symbol() }}{{ "%.0f"|format(existing_budget.amount) }}</li>
                <li><strong>Period:</strong> {{ existing_budget.start_date.strftime('%m/%d') }} - {{ existing_budget.end_date.strftime('%m/%d/%Y') }}</li>
                <li><strong>Spent:</strong> {{ get_currency_symbol() }}{{ "%.0f"|format(existing_budget.spent) }}</li>
            </ul>
            <small>Creating this budget will replace the existing one.</small>
        </div>
        {% endif %}
        
        {% if budget %}
        <!-- Budget Statistics -->
        <div class="card shadow-sm">
            <div class="card-header bg-light">
                <h6 class="card-title mb-0">
                    <i class="fas fa-chart-bar text-info"></i> Budget Statistics
                </h6>
            </div>
            <div class="card-body">
                <dl class="row mb-0">
                    <dt class="col-sm-6">Created:</dt>
                    <dd class="col-sm-6">{{ budget.created_at.strftime('%Y-%m-%d') if budget.created_at else 'N/A' }}</dd>
                    
                    <dt class="col-sm-6">Status:</dt>
                    <dd class="col-sm-6">
                        {% if budget.is_active %}
                            <span class="badge bg-success">Active</span>
                        {% else %}
                            <span class="badge bg-secondary">Inactive</span>
                        {% endif %}
                    </dd>
                    
                    <dt class="col-sm-6">Progress:</dt>
                    <dd class="col-sm-6">{{ "%.1f"|format((budget.spent / budget.amount * 100) if budget.amount > 0 else 0) }}%</dd>
                    
                    <dt class="col-sm-6">Days Left:</dt>
                    <dd class="col-sm-6">{{ budget.days_remaining if budget.days_remaining >= 0 else 0 }}</dd>
                </dl>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const amountInput = document.querySelector('input[name="amount"]');
    const startDateInput = document.querySelector('input[name="start_date"]');
    const endDateInput = document.querySelector('input[name="end_date"]');
    const preview = document.getElementById('budget-preview');
    
    function updatePreview() {
        const amount = parseFloat(amountInput.value) || 0;
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (amount > 0 && startDate && endDate && startDate < endDate) {
            const days = Math.ceil((endDate - startDate) / (1000 * 60 * 60 * 24)) + 1;
            const dailyLimit = amount / days;
            const weeklyLimit = dailyLimit * 7;
            
            document.getElementById('daily-limit').textContent = dailyLimit.toFixed(0);
            document.getElementById('weekly-limit').textContent = weeklyLimit.toFixed(0);
            document.getElementById('duration').textContent = days;
            
            preview.style.display = 'block';
        } else {
            preview.style.display = 'none';
        }
    }
    
    // Event listeners
    amountInput.addEventListener('input', updatePreview);
    startDateInput.addEventListener('change', updatePreview);
    endDateInput.addEventListener('change', updatePreview);
    
    // Auto-focus on amount field
    amountInput.focus();
    
    // Form validation
    const form = document.querySelector('form[method="POST"]:not([action*="delete"])');
    form.addEventListener('submit', function(e) {
        const amount = parseFloat(amountInput.value);
        const startDate = new Date(startDateInput.value);
        const endDate = new Date(endDateInput.value);
        
        if (!amount || amount <= 0) {
            e.preventDefault();
            showNotification('Please enter a valid budget amount', 'danger');
            return;
        }
        
        if (!startDate || !endDate) {
            e.preventDefault();
            showNotification('Please select start and end dates', 'danger');
            return;
        }
        
        if (startDate >= endDate) {
            e.preventDefault();
            showNotification('End date must be after start date', 'danger');
            return;
        }
    });
    
    // Initialize preview
    updatePreview();
});

// Quick period functions
function setCurrentMonth() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth(), 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 1, 0);
    
    document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    document.querySelector('input[name="start_date"]').dispatchEvent(new Event('change'));
}

function setNextMonth() {
    const now = new Date();
    const start = new Date(now.getFullYear(), now.getMonth() + 1, 1);
    const end = new Date(now.getFullYear(), now.getMonth() + 2, 0);
    
    document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    document.querySelector('input[name="start_date"]').dispatchEvent(new Event('change'));
}

function setQuarter() {
    const now = new Date();
    const quarter = Math.floor(now.getMonth() / 3);
    const start = new Date(now.getFullYear(), quarter * 3, 1);
    const end = new Date(now.getFullYear(), quarter * 3 + 3, 0);
    
    document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    document.querySelector('input[name="start_date"]').dispatchEvent(new Event('change'));
}

function setYear() {
    const now = new Date();
    const start = new Date(now.getFullYear(), 0, 1);
    const end = new Date(now.getFullYear(), 11, 31);
    
    document.querySelector('input[name="start_date"]').value = start.toISOString().split('T')[0];
    document.querySelector('input[name="end_date"]').value = end.toISOString().split('T')[0];
    document.querySelector('input[name="start_date"]').dispatchEvent(new Event('change'));
}

function setBudgetAmount(amount) {
    document.querySelector('input[name="amount"]').value = amount.toFixed(0);
    document.querySelector('input[name="amount"]').dispatchEvent(new Event('input'));
}

function showNotification(message, type) {
    if (window.ExpenseManager) {
        window.ExpenseManager.showNotification(message, type);
    } else {
        alert(message);
    }
}
</script>
{% endblock %}